// Generated by CoffeeScript 1.3.3
(function() {
  var AngryCat, AngryCatView, AngryCats, AngryCatsView;

  this.MyApp = new Backbone.Marionette.Application();

  MyApp.addRegions({
    mainRegion: "#content"
  });

  AngryCat = Backbone.Model.extend({
    defaults: {
      votes: 0
    },
    addVote: function() {
      return this.set('votes', this.get('votes') + 1);
    },
    rankUp: function() {
      return this.set({
        rank: this.get('rank') - 1
      });
    },
    rankDown: function() {
      return this.set({
        rank: this.get('rank') + 1
      });
    }
  });

  AngryCats = Backbone.Collection.extend({
    model: AngryCat,
    initialize: function(cats) {
      var rank, self;
      rank = 1;
      _.each(cats, function(cat) {
        cat.set("rank", rank);
        return ++rank;
      });
      this.on('add', function(cat) {
        var error;
        if (!cat.get('rank')) {
          error = Error('Cat must have a rank defined before being added to the collection');
          error.name = "NoRankError";
          throw error;
        }
      });
      self = this;
      MyApp.vent.on("rank:up", function(cat) {
        if (cat.get("rank") === 1) {
          return true;
        }
        self.rankUp(cat);
        return self.sort();
      });
      MyApp.vent.on("rank:down", function(cat) {
        if (cat.get("rank") === self.size()) {
          return true;
        }
        self.rankDown(cat);
        return self.sort();
      });
      return MyApp.vent.on("cat:disqualify", function(cat) {
        var catsToUpRank, disqualifiedRank;
        disqualifiedRank = cat.get('rank');
        catsToUpRank = self.filter(function(cat) {
          return cat.get('rank') > disqualifiedRank;
        });
        catsToUpRank.forEach(function(cat) {
          return cat.rankUp();
        });
        return self.trigger('reset');
      });
    },
    comparator: function(cat) {
      return cat.get('rank');
    },
    rankUp: function(cat) {
      var otherCat, rankToSwap;
      rankToSwap = cat.get("rank") - 1;
      otherCat = this.at(rankToSwap - 1);
      cat.rankUp();
      return otherCat.rankDown();
    },
    rankDown: function(cat) {
      var otherCat, rankToSwap;
      rankToSwap = cat.get('rank') + 1;
      otherCat = this.at(rankToSwap - 1);
      cat.rankDown();
      return otherCat.rankUp();
    }
  });

  AngryCatView = Backbone.Marionette.ItemView.extend({
    template: "#angry_cat-template",
    tagName: "tr",
    className: "angry_cat",
    events: {
      "click .rank_up img": "rankUp",
      "click .rank_down img": "rankDown",
      "click a.disqualify": "disqualify"
    },
    disqualify: function() {
      MyApp.vent.trigger("cat:disqualify", this.model);
      return this.model.destroy();
    },
    rankUp: function() {
      this.model.addVote();
      return MyApp.vent.trigger("rank:up", this.model);
    },
    rankDown: function() {
      this.model.addVote();
      return MyApp.vent.trigger("rank:down", this.model);
    }
  });

  AngryCatsView = Backbone.Marionette.CompositeView.extend({
    tagName: "table",
    id: "angry_cats",
    className: "table-striped table-bordered",
    template: "#angry_cats-template",
    itemView: AngryCatView,
    appendHtml: function(collectionView, itemView) {
      return collectionView.$("tbody").append(itemView.el);
    }
  });

  MyApp.addInitializer(function(options) {
    var angryCatsView;
    angryCatsView = new AngryCatsView({
      collection: options.cats
    });
    return MyApp.mainRegion.show(angryCatsView);
  });

  $(document).ready(function() {
    var cats;
    cats = new AngryCats([
      new AngryCat({
        name: 'Marshmellow',
        image_path: 'assets/images/cat1.jpg'
      }), new AngryCat({
        name: 'Pancake',
        image_path: 'assets/images/cat2.jpg'
      }), new AngryCat({
        name: 'Fuzzy',
        image_path: 'assets/images/cat3.jpg'
      }), new AngryCat({
        name: 'Domino',
        image_path: 'assets/images/cat4.jpg'
      })
    ]);
    MyApp.start({
      cats: cats
    });
    return cats.add(new AngryCat({
      name: 'Cranky Cat',
      image_path: 'assets/images/cat5.jpg',
      rank: cats.size() + 1
    }));
  });

}).call(this);
